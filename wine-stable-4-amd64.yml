version: 1

script:
  # Remove any previous build cache data
  - rm -rf AppDir appimage-builder-cache/var/cache/apt/archives/*wine* || true
  - mkdir AppDir && cp wrapper AppDir
  # Add winetricks & cabextract
  - wget -q "https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks" -P ./AppDir/bin && chmod +x ./AppDir/bin/winetricks
  # Copy App icon to AppDir/usr/share/icons needed prior to appimage-builder ver 1.x.x
  - mkdir -p AppDir/usr/share/icons ; cp wine.svg AppDir/usr/share/icons

AppDir:
  path: ./AppDir
  
  app_info:
    id: org.winehq.wine
    name: wine
    icon: wine
    version: stable
    exec: bin/bash
    exec_args: wrapper $@

  apt:
    arch: [amd64]
    sources:
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ focal main restricted universe multiverse'
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ focal-updates main restricted universe multiverse'
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ focal-backports main restricted universe multiverse'
        key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x3b4fe6acc0b21f32'
      - sourceline: 'deb https://dl.winehq.org/wine-builds/ubuntu/ focal main'
        key_url: 'https://dl.winehq.org/wine-builds/winehq.key'

    include:
      - wine-stable-amd64=4.0.4~focal
      - bash
      - cabextract
      - dash
      - perl
      - coreutils
      - mesa-utils
      - unionfs-fuse

  files:
    exclude:
      - sbin
      - var
      - etc/alternatives
      - etc/apt
      - etc/cron.daily
      - etc/dpkg
      - etc/mysql
      - etc/sane.d
      - etc/sensors.d
      - etc/skel
      - etc/snmp
      - etc/udev
      - etc/gss
      - etc/init.d
      - etc/logrotate.d
      - lib/modprobe.d
      - lib/systemd
      - lib/udev
      - usr/lib/mime
      - usr/lib/sasl2
      - usr/lib/tmpfiles.d
      - usr/sbin
      - usr/share/man
      - usr/share/doc
      - usr/share/adduser
      - usr/share/apport
      - usr/share/bash-completion
      - usr/share/bug
      - usr/share/debconf
      - usr/share/doc
      - usr/share/doc-base
      - usr/share/dpkg
      - usr/share/glib-2.0
      - usr/share/gst-plugins-base
      - usr/share/hal
      - usr/share/info
      - usr/share/initramfs-tools
      - usr/share/libgphoto2
      - usr/share/lintian
      - usr/share/menu
      - usr/share/metainfo
      - usr/share/misc
      - usr/share/mysql-common
      - usr/share/pixmaps
      - usr/share/pkgconfig
      - usr/share/polkit-1
      - usr/share/snmp
      - usr/share/zoneinfo
      - usr/share/zoneinfo-icu
      - usr/share/zsh
      - opt/wine-stable/share/man
      - opt/wine-stable/lib64/wine/*.a
      - opt/wine-stable/lib64/wine/*.def

  after_bundle:
    # this is executed after the packages and files are added
    - |
     WINE_VER="4.0.4"
     wget -q -c https://dl.winehq.org/wine-builds/ubuntu/dists/focal/main/binary-amd64/wine-stable_${WINE_VER}~focal_amd64.deb
     dpkg -x "wine-stable_${WINE_VER}~focal_amd64.deb" AppDir/usr/
     cp -r AppDir/usr/opt/wine-stable/* AppDir/usr

     # Cleanup
     rm -rf AppDir/usr/{otp,usr}
     rm -rf AppDir/usr/share/{applications,man,doc}
     rm -rf AppDir/opt/wine-stable/share/{applications,man}

     # Disable FileOpenAssociations
     sed -i 's|    LicenseInformation|    LicenseInformation,\\\n    FileOpenAssociations|g;$a \\n[FileOpenAssociations]\nHKCU,Software\\Wine\\FileOpenAssociations,"Enable",,"N"' AppDir/opt/wine-stable/share/wine/wine.inf

     # Disable winemenubuilder
     sed -i 's|    FileOpenAssociations|    FileOpenAssociations,\\\n    DllOverrides|;$a \\n[DllOverrides]\nHKCU,Software\\Wine\\DllOverrides,"*winemenubuilder.exe",,""' AppDir/opt/wine-stable/share/wine/wine.inf
     sed -i '/\%11\%\\winemenubuilder.exe -a -r/d' AppDir/opt/wine-stable/share/wine/wine.inf

     # Pre patch setting wine blue theme by default
     sed -i 's|    DllOverrides|    DllOverrides,\\\n    ThemeSet|;$a \\n[ThemeSet]\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"ColorName",,"Blue"\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"DllName",,"C:\\windows\\Resources\\Themes\\light\\light.msstyles"\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"ThemeActive",,"1"\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"FlatMenu",0x10001,0x00000000\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"GradientCaption",0x10001,0x00000001\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"SizeName",,"NormalSize"\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"IconTitleFont",1,f5,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,\\\n00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,6c,00,\\\n20,00,44,00,6c,00,67,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Software\\Microsoft\\Windows\\CurrentVersion\\ThemeManager,"NonClientMetrics",1,f8,01,00,00,01,00,00,00,10,00,00,00,10,00,00,00,12,00,\\\n00,00,12,00,00,00,f5,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,bc,02,00,\\\n00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,6c,00,\\\n20,00,44,00,6c,00,67,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,0f,00,\\\n00,00,0f,00,00,00,f5,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,\\\n00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,6c,00,\\\n20,00,44,00,6c,00,67,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,12,00,\\\n00,00,12,00,00,00,f5,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,\\\n00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,6c,00,\\\n20,00,44,00,6c,00,67,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,f5,ff,\\\nff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,00,00,00,00,00,00,00,00,\\\n22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,6c,00,20,00,44,00,6c,00,67,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,f5,ff,ff,ff,00,00,00,00,00,00,\\\n00,00,00,00,00,00,90,01,00,00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,\\\n00,6d,00,61,00,00,00,6c,00,20,00,44,00,6c,00,67,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Colors,"ActiveBorder",,"255 255 255"\nHKCU,Control Panel\\Colors,"ActiveTitle",,"50 150 250"\nHKCU,Control Panel\\Colors,"AppWorkSpace",,"128 128 128"\nHKCU,Control Panel\\Colors,"Background",,"37 111 149"\nHKCU,Control Panel\\Colors,"ButtonAlternateFace",,"255 255 255"\nHKCU,Control Panel\\Colors,"ButtonDkShadow",,"106 106 106"\nHKCU,Control Panel\\Colors,"ButtonFace",,"245 245 245"\nHKCU,Control Panel\\Colors,"ButtonHilight",,"255 255 255"\nHKCU,Control Panel\\Colors,"ButtonLight",,"227 227 227"\nHKCU,Control Panel\\Colors,"ButtonShadow",,"166 166 166"\nHKCU,Control Panel\\Colors,"ButtonText",,"0 0 0"\nHKCU,Control Panel\\Colors,"GradientActiveTitle",,"50 150 250"\nHKCU,Control Panel\\Colors,"GradientInactiveTitle",,"245 245 245"\nHKCU,Control Panel\\Colors,"GrayText",,"166 166 166"\nHKCU,Control Panel\\Colors,"Hilight",,"48 150 250"\nHKCU,Control Panel\\Colors,"HilightText",,"255 255 255"\nHKCU,Control Panel\\Colors,"HotTrackingColor",,"224 224 224"\nHKCU,Control Panel\\Colors,"InactiveBorder",,"255 255 255"\nHKCU,Control Panel\\Colors,"InactiveTitle",,"245 245 245"\nHKCU,Control Panel\\Colors,"InactiveTitleText",,"100 100 100"\nHKCU,Control Panel\\Colors,"InfoText",,"0 0 0"\nHKCU,Control Panel\\Colors,"InfoWindow",,"255 255 255"\nHKCU,Control Panel\\Colors,"Menu",,"255 255 255"\nHKCU,Control Panel\\Colors,"MenuBar",,"255 255 255"\nHKCU,Control Panel\\Colors,"MenuHilight",,"48 150 250"\nHKCU,Control Panel\\Colors,"MenuText",,"0 0 0"\nHKCU,Control Panel\\Colors,"Scrollbar",,"255 255 255"\nHKCU,Control Panel\\Colors,"TitleText",,"0 0 0"\nHKCU,Control Panel\\Colors,"Window",,"255 255 255"\nHKCU,Control Panel\\Colors,"WindowFrame",,"158 158 158"\nHKCU,Control Panel\\Colors,"WindowText",,"0 0 0"\nHKCU,Control Panel\\Desktop\\WindowMetrics,"BorderWidth",,"1"\nHKCU,Control Panel\\Desktop\\WindowMetrics,"CaptionFont",1,08,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,bc,02,00,00,\\\n00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Desktop\\WindowMetrics,"IconFont",1,f5,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,00,00,\\\n00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Desktop\\WindowMetrics,"MenuFont",1,08,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,00,00,\\\n00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Desktop\\WindowMetrics,"MessageFont",1,08,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,00,\\\n00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Desktop\\WindowMetrics,"SmCaptionFont",1,fa,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,\\\n00,00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00\nHKCU,Control Panel\\Desktop\\WindowMetrics,"StatusFont",1,08,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,90,01,00,00,\\\n00,00,00,00,00,00,00,22,54,00,61,00,68,00,6f,00,6d,00,61,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\\n00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00' AppDir/opt/wine-stable/share/wine/wine.inf

  runtime:
    path_mappings:
    - /opt/wine-stable:$APPDIR/opt/wine-stable

  test:
    debian:
      image: appimagecrafters/tests-env:debian-stable
      command: "./AppRun --version"
    centos:
      image: appimagecrafters/tests-env:centos-7
      command: "./AppRun --version"
    arch:
      image: appimagecrafters/tests-env:archlinux-latest
      command: "./AppRun --version"
    fedora:
      image: appimagecrafters/tests-env:fedora-30
      command: "./AppRun --version"
    ubuntu:
      image: appimagecrafters/tests-env:ubuntu-xenial
      command: "./AppRun --version"

AppImage:
  update-information: None
  sign-key: None
  arch: x86_64

